on:
  push:
    branches:
      - main 

jobs:
  flyway_migration:
    runs-on: runner1

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install OpenJDK
        run: sudo apt-get install -y openjdk-11-jdk

      - name: Download and Unzip Flyway
        run: |
          wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/8.5.6/flyway-commandline-8.5.6-linux-x64.tar.gz | tar xvz
          sudo mv flyway-8.5.6 /opt/flyway
          echo "Successfully updated the flyway download"

  migrate:
    needs: flyway_migration
    runs-on: self-hosted

    steps:
      - name: Configure Flyway on AWS EC2
        run: |
          cd /opt/flyway/conf
          touch flyway.conf
          echo "flyway.url=jdbc:sqlserver://${{ secrets.DB_BUILD_URL }}:1433;encrypt=true;trustServerCertificate=true;" >> flyway.conf
          echo "flyway.user=${{ secrets.DB_BUILD_USERNAME }}" >> flyway.conf
          echo "flyway.password=${{ secrets.DB_BUILD_PASSWORD }}" >> flyway.conf

      - name: Run Flyway Info
        run: |
          cd /opt/flyway
          ./flyway info
        continue-on-error: true

      - name: Run Flyway Migrate
        run: |
          cd /opt/flyway
          ./flyway migrate
